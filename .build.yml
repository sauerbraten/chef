image: alpine/edge
packages:
  - go
  - rsync
sources:
  - https://git.sr.ht/~sauerbraten/chef
environment:
  DEPLOY: chef.sauerworld.org
  GOPATH: $HOME
secrets:
  - 98c1b481-b37f-452f-872a-8f8fa1833249
tasks:
  - prepare_gopath: |
      mkdir -p src/github.com/sauerbraten
      mv chef src/github.com/sauerbraten/
  - version: |
      cd src/github.com/sauerbraten/chef/cmd/chef
      sed -i "s/<filled in by CI service>/$(git rev-parse --short HEAD)/" main.go
  - build: |
      cd src/github.com/sauerbraten/chef/cmd/chef
      go get
      go build
  - deploy: |
      cd src/github.com/sauerbraten/chef
      rsync --rsh="ssh -o StrictHostKeyChecking=no" -rPq chef.sqlite.schema ci@$DEPLOY:~/chef/
      ssh -o StrictHostKeyChecking=no ci@$DEPLOY 'cd chef; if [ ! -f chef.sqlite ] ; then sqlite3 chef.sqlite < chef.sqlite.schema ; fi'
      cd cmd/chef
      rsync --rsh="ssh -o StrictHostKeyChecking=no" -rPq css templates config.json chef ci@$DEPLOY:~/chef/
      ssh -o StrictHostKeyChecking=no ci@$DEPLOY 'killall chef'
      ssh -o StrictHostKeyChecking=no ci@$DEPLOY 'cd chef; nohup ./chef &>> log.txt &'
